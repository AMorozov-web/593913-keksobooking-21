(()=>{"use strict";window.util={toggleFormElements:(e,t=!1)=>{for(const o of e.children)o.disabled=t},declTextByNumber:(e,t)=>{const o=Math.abs(e)%100,r=e%10;return o>10&&o<20?t[2]:r>1&&r<5?t[1]:1===r?t[0]:t[2]},checkPressEnter:(e,t)=>{"Enter"===e.key&&t()},checkPressEsc:(e,t)=>{"Escape"===e.key&&t()},setIdToElements:e=>e.map(((e,t)=>Object.assign({id:t},e))),debounceFunction:(e,t=500)=>{let o=null;return(...r)=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e(...r)}),t)}}},(()=>{const e="https://21.javascript.pages.academy/keksobooking",t=(e,t,o,r,n)=>{const s=new XMLHttpRequest;s.responseType="json",s.timeout=3e3,s.open(t,e),s.send(n),s.addEventListener("load",(()=>{200===s.status?o(s.response):r(`Ошибка. Статус ответа: ${s.status} ${s.statusText}`)})),s.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{r(`Запрос не успел выполниться за ${s.timeout} мс`)}))};window.backend={load:(o,r)=>{t(e+"/data","GET",o,r,null)},upload:(o,r,n)=>{t(""+e,"POST",r,n,o)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=o=>{const r=document.createDocumentFragment();o.forEach((e=>{r.appendChild((e=>{if(!e.offer)return null;const o=t.cloneNode(!0);return o.style=`left: ${e.location.x}px; top: ${e.location.y}px;`,o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o.dataset.id=e.id,o})(e))})),e.appendChild(r)},r=()=>{e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},n=window.util.debounceFunction((e=>{window.card.closeCard(),r(),o(e)}));window.pin={render:o,click:e=>{const t=e.target.closest('button[type="button"]');if(t&&!e.target.classList.contains("map__pin--main")&&!t.classList.contains("map__pin--active")){const e=parseInt(t.dataset.id,10),o=window.data.find((t=>t.id===e));window.card.render(o),t.classList.add("map__pin--active")}},remove:r,update:n}})(),(()=>{const e=["комната","комнаты","комнат"],t=["гостя","гостей","гостей"],o=document.querySelector("#card").content.querySelector(".map__card"),r=document.querySelector(".map"),n=document.querySelector(".map__pins"),s=document.querySelector(".map__filters-container"),a={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},i=e=>{switch(e.tagName.toLowerCase()){case"p":case"h3":case"h4":""===e.textContent&&e.remove();break;case"img":e.src||e.remove()}},c=()=>{const e=r.querySelector(".popup");e&&(e.remove(),n.querySelector(".map__pin--active").classList.remove("map__pin--active"))},d=e=>{window.util.checkPressEsc(e,c),document.removeEventListener("keydown",d)};window.card={render:n=>{c();const l=(r=>{const{author:n,offer:s}=r,{avatar:d}=n,{title:l,address:u,price:m,type:p,features:w,photos:y,rooms:v,guests:f,checkin:g,checkout:_,description:h}=s,S=o.cloneNode(!0),E=S.children,q=S.querySelector(".popup__close"),L=S.querySelector(".popup__features"),b=S.querySelector(".popup__photos"),k=`${v} ${window.util.declTextByNumber(v,e)} для ${f} ${window.util.declTextByNumber(f,t)}`;var x,I;S.querySelector(".popup__avatar").src=d,S.querySelector(".popup__title").textContent=l,S.querySelector(".popup__text--address").textContent=u,S.querySelector(".popup__text--price").textContent=m+"₽/ночь"||"",S.querySelector(".popup__type").textContent=""+a[p],S.querySelector(".popup__text--capacity").textContent=k,S.querySelector(".popup__text--time").textContent=`Заезд после ${g}, выезд до ${_}`,S.querySelector(".popup__description").textContent=""+h,L.innerHTML="",I=L,0!==(x=w).length?x.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),I.appendChild(t)})):I.remove(),((e,t)=>{if(0===e.length)return void t.remove();const o=t.querySelector(".popup__photo").cloneNode(!0);t.innerHTML="",e.forEach((e=>{t.appendChild(o),o.src=e}))})(y,b);for(const e of E)i(e);return q.addEventListener("click",(()=>{c()})),S})(n);r.insertBefore(l,s),document.addEventListener("keydown",d)},close:c}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".ad-form"),o=t.querySelector("#title"),r=t.querySelector("#address"),n=t.querySelector("#price"),s=t.querySelector("#type"),a=t.querySelector("#timein"),i=t.querySelector("#timeout"),c=t.querySelector("#room_number"),d=t.querySelector("#capacity"),l=t.querySelector("#avatar"),u=t.querySelector(".ad-form-header__preview img"),m=t.querySelector("#images"),p=t.querySelector(".ad-form__photo"),w=o.minLength,y=o.maxLength,v={palace:1e4,house:5e3,flat:1e3,bungalow:0},f=()=>{const t=parseInt(e.style.top,10),o=parseInt(e.style.left,10),n=Math.floor(o+32.5),s=window.form.isPageActive?t+84:Math.floor(t+32.5);r.value=`${n}, ${s}`},g=()=>{const e={badInput:"Только числовое значение",rangeOverflow:"Максимальная цена - "+n.max,rangeUnderflow:"Минимальная цена - "+n.min,valueMissing:"Заполните это поле"},t=Object.keys(e).find((e=>n.validity[e]));n.setCustomValidity(t?e[t]:"")},_=e=>{n.setAttribute("min",e),n.setAttribute("placeholder",e)},h=e=>{a.value=e.target.value,i.value=e.target.value},S=()=>{const e=c.value,t=d.value,o="100";e===o&&"0"!==t||e!==o&&"0"===t?d.setCustomValidity("Возможен только вариант: 100 комнат - не для гостей"):e!==o&&e<t?d.setCustomValidity("Количество комнат не может быть меньше числа гостей"):d.setCustomValidity(""),d.reportValidity()};_(v[s.value]),g(),S(),o.addEventListener("change",(()=>{let e=o.value.length;e<w?o.setCustomValidity(`Минимум ${w} символов, добавьте ещё ${w-e}`):e>y?o.setCustomValidity(`Максимум ${y} символов, удалите лишние ${e-y}`):o.setCustomValidity(""),o.reportValidity()})),n.addEventListener("change",g),s.addEventListener("change",(()=>{_(v[s.value])})),a.addEventListener("change",h),i.addEventListener("change",h),c.addEventListener("change",S),d.addEventListener("change",S),l.addEventListener("change",(()=>window.upload.setImagePreview(l,u))),m.addEventListener("change",(()=>window.upload.setImagePreview(m,p))),window.form={MAIN_PIN_OFFSET_X:65,MAIN_PIN_ACTIVE_OFFSET_Y:84,isPageActive:!1,enable:()=>{t.classList.remove("ad-form--disabled"),window.util.toggleFormElements(t)},disable:()=>{t.classList.contains("ad-form--disabled")||t.classList.add("ad-form--disabled"),document.querySelectorAll('input[type="checkbox"]:checked').forEach((e=>{e.checked=!1})),t.reset(),window.upload.removeImagePreview(u),window.upload.removeImagePreview(p),window.util.toggleFormElements(t,!0),f()},setAddress:f}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o={top:e.offsetTop+130-window.form.MAIN_PIN_ACTIVE_OFFSET_Y,bottom:630-window.form.MAIN_PIN_ACTIVE_OFFSET_Y,left:0+Math.ceil(window.form.MAIN_PIN_OFFSET_X/2)-t.offsetWidth,right:1200+Math.ceil(window.form.MAIN_PIN_OFFSET_X/2)-t.offsetWidth};t.addEventListener("mousedown",(e=>{let r={x:e.clientX,y:e.clientY};const n=e=>{e.preventDefault();const n=r.x-e.clientX,s=r.y-e.clientY;r={x:e.clientX,y:e.clientY};const a={x:t.offsetLeft-n,y:t.offsetTop-s};a.y<o.top?a.y=o.top:a.y>o.bottom&&(a.y=o.bottom),a.x<o.left?a.x=o.left:a.x>o.right&&(a.x=o.right),t.style.left=a.x+"px",t.style.top=a.y+"px"},s=e=>{e.preventDefault(),window.form.setAddress(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",s)}))})(),(()=>{const e=t=>{const o=document.querySelector(".error");window.util.checkPressEsc(t,(()=>o.remove())),document.removeEventListener("keydown",e)},t=e=>{const o=document.querySelector(".success");window.util.checkPressEsc(e,(()=>o.remove())),document.removeEventListener("keydown",t)};window.message={error:t=>{const o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),r=document.querySelector("main"),n=o.querySelector(".error__message");t&&(n.textContent=t),r.insertAdjacentElement("afterbegin",o),o.addEventListener("click",(()=>{o.remove()})),document.addEventListener("keydown",e)},success:()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.querySelector("main").insertAdjacentElement("afterbegin",e),e.addEventListener("click",(()=>{e.remove()})),document.addEventListener("keydown",t)}}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),n=t.querySelector("#housing-rooms"),s=t.querySelector("#housing-guests"),a=t.querySelector("#housing-features"),i=t=>{switch(r.value){case"low":return t.offer.price<1e4;case"middle":return t.offer.price>=1e4&&t.offer.price<5e4;case"high":return t.offer.price>=5e4;case e:return!0;default:return!1}},c=t=>t.offer.guests>=+s.value||s.value===e,d=e=>Array.from(a.querySelectorAll("input:checked")).every((t=>e.offer.features.includes(t.value))),l=t=>{const r=[];for(let s=0;s<t.length;s++)if((t[s].offer.type===o.value||o.value===e)&&i(t[s])&&(t[s].offer.rooms===+n.value||n.value===e)&&c(t[s])&&d(t[s])&&r.push(t[s]),5===r.length)return r;return r};t.addEventListener("change",(()=>{const e=l(window.data);window.pin.update(e)})),window.filter={getFilteredData:l,enable:()=>{window.util.toggleFormElements(t)},disable:()=>{t.reset(),window.util.toggleFormElements(t,!0)}}})(),(()=>{const e=["gif","jpg","jpeg","png"];window.upload={setImagePreview:(t,o)=>{const r=t.files[0],n=r.type.toLowerCase();if(e.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{"img"!==o.tagName.toLowerCase()?(o.style.backgroundSize="contain",o.style.backgroundImage=`url(${e.result})`):o.src=e.result})),e.readAsDataURL(r)}},removeImagePreview:e=>{"img"!==e.tagName.toLowerCase()?e.style.backgroundImage="":e.src="img/muffin-grey.svg"}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o=document.querySelector(".map__pins"),r=document.querySelector(".ad-form"),n=r.querySelector(".ad-form__reset"),s=e=>{window.util.checkPressEnter(e,l)},a=e=>{0===e.button&&l()},i=e=>{window.data=window.util.setIdToElements(e);const t=window.filter.getFilteredData(window.data);window.filter.enable(),window.pin.render(t)},c=()=>{window.message.success(),r.reset(),u()},d=e=>{window.message.error(e)},l=()=>{e.classList.remove("map--faded"),window.form.isPageActive=!0,window.form.enable(),window.backend.load(i,d),t.removeEventListener("mousedown",a),t.removeEventListener("keydown",s),o.addEventListener("click",window.pin.click)},u=()=>{e.classList.contains("map--faded")||e.classList.add("map--faded"),window.form.isPageActive=!1,t.style.top="375px",t.style.left="570px",window.form.disable(),window.filter.disable(),window.card.close(),window.pin.remove(),t.addEventListener("mousedown",a),t.addEventListener("keydown",s),o.removeEventListener("click",window.pin.click)};n.addEventListener("mousedown",(()=>{u()})),r.addEventListener("submit",(e=>{const t=new FormData(r);window.backend.upload(t,c,d),e.preventDefault()})),u()})()})();