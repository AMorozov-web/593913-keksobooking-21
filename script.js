(()=>{"use strict";window.util={toggleFormElements:(e,t=!1)=>{for(let o of e.children)o.disabled=t},getRandomElement:e=>e[Math.floor(Math.random()*e.length)],getRandomInRange:(e,t)=>Math.floor(e+Math.random()*(t+1-e)),declTextByNumber:(e,t)=>{const o=Math.abs(e)%100,n=e%10;return o>10&&o<20?t[2]:n>1&&n<5?t[1]:1===n?t[0]:t[2]},checkPressEnter:(e,t)=>{"Enter"===e.key&&t()},checkPressEsc:(e,t)=>{"Escape"===e.key&&t()},setIdToElements:e=>e.map(((e,t)=>Object.assign({id:t},e))),debounceFunction:(e,t=500)=>{let o=null;return(...n)=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e(...n)}),t)}}},(()=>{const e="https://21.javascript.pages.academy/keksobooking",t=(e,t,o,n,r)=>{const s=new XMLHttpRequest;s.responseType="json",s.timeout=3e3,s.open(t,e),s.send(r),s.addEventListener("load",(()=>{200===s.status?o(s.response):n(`Ошибка. Статус ответа: ${s.status} ${s.statusText}`)})),s.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${s.timeout} мс`)}))};window.backend={load:(o,n)=>{t(e+"/data","GET",o,n,null)},upload:(o,n,r)=>{t(""+e,"POST",n,r,o)}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=o=>{const n=document.createDocumentFragment();o.forEach((e=>{n.appendChild((e=>{if(!e.offer)return null;const o=t.cloneNode(!0);return o.style=`left: ${e.location.x}px; top: ${e.location.y}px;`,o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o.dataset.id=e.id,o})(e))})),e.appendChild(n)},n=()=>{e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},r=window.util.debounceFunction((e=>{window.card.closeCard(),n(),o(e)}));window.pin={placePins:o,onMapPinsClick:e=>{const t=e.target.closest('button[type="button"]');if(t&&!e.target.classList.contains("map__pin--main")&&!t.classList.contains("map__pin--active")){const e=parseInt(t.dataset.id,10),o=window.data.find((t=>t.id===e));window.card.placeCard(o),t.classList.add("map__pin--active")}},removePins:n,updatePins:r}})(),(()=>{const e=["комната","комнаты","комнат"],t=["гостя","гостей","гостей"],o=document.querySelector("#card").content.querySelector(".map__card"),n=document.querySelector(".map"),r=document.querySelector(".map__pins"),s=document.querySelector(".map__filters-container"),a={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},i=e=>{switch(e.tagName.toLowerCase()){case"p":case"h3":case"h4":""===e.textContent&&e.remove();break;case"img":e.src||e.remove()}},c=()=>{const e=n.querySelector(".popup");e&&(e.remove(),r.querySelector(".map__pin--active").classList.remove("map__pin--active"))},d=e=>{window.util.checkPressEsc(e,c),document.removeEventListener("keydown",d)};window.card={placeCard:r=>{c();const l=(n=>{const{author:r,offer:s}=n,{avatar:d}=r,{title:l,address:u,price:m,type:p,features:w,photos:y,rooms:f,guests:v,checkin:g,checkout:_,description:h}=s,S=o.cloneNode(!0),E=S.children,q=S.querySelector(".popup__close"),L=S.querySelector(".popup__features"),b=S.querySelector(".popup__photos"),k=`${f} ${window.util.declTextByNumber(f,e)} для ${v} ${window.util.declTextByNumber(v,t)}`;S.querySelector(".popup__avatar").src=d,S.querySelector(".popup__title").textContent=l,S.querySelector(".popup__text--address").textContent=u,S.querySelector(".popup__text--price").textContent=m+"₽/ночь"||"",S.querySelector(".popup__type").textContent=""+a[p],S.querySelector(".popup__text--capacity").textContent=k,S.querySelector(".popup__text--time").textContent=`Заезд после ${g}, выезд до ${_}`,S.querySelector(".popup__description").textContent=""+h,L.innerHTML="",((e,t)=>{if(0!==e.length)for(let o=0;o<e.length;o++){const n=document.createElement("li");n.classList.add("popup__feature","popup__feature--"+e[o]),t.appendChild(n)}else t.remove()})(w,L),((e,t)=>{if(0===e.length)return void t.remove();const o=t.querySelector(".popup__photo").cloneNode(!0);t.innerHTML="",e.forEach((e=>{t.appendChild(o),o.src=e}))})(y,b);for(let e of E)i(e);return q.addEventListener("click",(()=>{c()})),S})(r);n.insertBefore(l,s),document.addEventListener("keydown",d)},closeCard:c}})(),(()=>{const e=document.querySelector(".map__filters"),t=document.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),n=o.querySelector("#title"),r=o.querySelector("#address"),s=o.querySelector("#price"),a=o.querySelector("#type"),i=o.querySelector("#timein"),c=o.querySelector("#timeout"),d=o.querySelector("#room_number"),l=o.querySelector("#capacity"),u=o.querySelector("#avatar"),m=o.querySelector(".ad-form-header__preview img"),p=o.querySelector("#images"),w=o.querySelector(".ad-form__photo"),y=n.minLength,f=n.maxLength,v={palace:1e4,house:5e3,flat:1e3,bungalow:0},g=()=>{const e=parseInt(t.style.top,10),o=parseInt(t.style.left,10),n=Math.floor(o+32.5),s=window.form.isPageActive?e+84:Math.floor(e+32.5);r.value=`${n}, ${s}`},_=()=>{const e={badInput:"Только числовое значение",rangeOverflow:"Максимальная цена - "+s.max,rangeUnderflow:"Минимальная цена - "+s.min,valueMissing:"Заполните это поле"},t=Object.keys(e).find((e=>s.validity[e]));s.setCustomValidity(t?e[t]:"")},h=e=>{s.setAttribute("min",e),s.setAttribute("placeholder",e)},S=e=>{i.value=e.target.value,c.value=e.target.value},E=()=>{const e=d.value,t=l.value,o="100";e===o&&"0"!==t||e!==o&&"0"===t?l.setCustomValidity("Возможен только вариант: 100 комнат - не для гостей"):e!==o&&e<t?l.setCustomValidity("Количество комнат не может быть меньше числа гостей"):l.setCustomValidity(""),l.reportValidity()};h(v[a.value]),_(),E(),n.addEventListener("change",(()=>{let e=n.value.length;e<y?n.setCustomValidity(`Минимум ${y} символов, добавьте ещё ${y-e}`):e>f?n.setCustomValidity(`Максимум ${f} символов, удалите лишние ${e-f}`):n.setCustomValidity(""),n.reportValidity()})),s.addEventListener("change",_),a.addEventListener("change",(()=>{h(v[a.value])})),i.addEventListener("change",S),c.addEventListener("change",S),d.addEventListener("change",E),l.addEventListener("change",E),u.addEventListener("change",(()=>window.upload.setImagePreview(u,m))),p.addEventListener("change",(()=>window.upload.setImagePreview(p,w))),window.form={MAIN_PIN_OFFSET_X:65,MAIN_PIN_ACTIVE_OFFSET_Y:84,isPageActive:!1,enableForm:()=>{o.classList.remove("ad-form--disabled"),window.util.toggleFormElements(o)},disableForm:()=>{o.classList.contains("ad-form--disabled")||o.classList.add("ad-form--disabled"),window.upload.removeImagePreview(m),window.upload.removeImagePreview(w),window.util.toggleFormElements(o,!0),g()},enableFilters:()=>{window.util.toggleFormElements(e)},disableFilters:()=>{window.util.toggleFormElements(e,!0)},setAddress:g}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o={top:e.offsetTop+130-window.form.MAIN_PIN_ACTIVE_OFFSET_Y,bottom:630-window.form.MAIN_PIN_ACTIVE_OFFSET_Y,left:0+Math.ceil(window.form.MAIN_PIN_OFFSET_X/2)-t.offsetWidth,right:1200+Math.ceil(window.form.MAIN_PIN_OFFSET_X/2)-t.offsetWidth};t.addEventListener("mousedown",(e=>{let n={x:e.clientX,y:e.clientY};const r=e=>{e.preventDefault();const r=n.x-e.clientX,s=n.y-e.clientY;n={x:e.clientX,y:e.clientY};const a={x:t.offsetLeft-r,y:t.offsetTop-s};a.y<o.top?a.y=o.top:a.y>o.bottom&&(a.y=o.bottom),a.x<o.left?a.x=o.left:a.x>o.right&&(a.x=o.right),t.style.left=a.x+"px",t.style.top=a.y+"px"},s=e=>{e.preventDefault(),window.form.setAddress(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",s)}))})(),(()=>{const e=t=>{const o=document.querySelector(".error");window.util.checkPressEsc(t,(()=>o.remove())),document.removeEventListener("keydown",e)},t=e=>{const o=document.querySelector(".success");window.util.checkPressEsc(e,(()=>o.remove())),document.removeEventListener("keydown",t)};window.message={renderErrorMessage:t=>{const o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),n=document.querySelector("main"),r=o.querySelector(".error__message");t&&(r.textContent=t),n.insertAdjacentElement("afterbegin",o),o.addEventListener("click",(()=>{o.remove()})),document.addEventListener("keydown",e)},renderSuccessMessage:()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.querySelector("main").insertAdjacentElement("afterbegin",e),e.addEventListener("click",(()=>{e.remove()})),document.addEventListener("keydown",t)}}})(),(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),s=t.querySelector("#housing-guests"),a=t.querySelector("#housing-features"),i=t=>{switch(n.value){case"low":return t.offer.price<1e4;case"middle":return t.offer.price>=1e4&&t.offer.price<5e4;case"high":return t.offer.price>=5e4;case e:return!0;default:return!1}},c=t=>t.offer.guests>=+s.value||s.value===e,d=e=>Array.from(a.querySelectorAll("input:checked")).every((t=>e.offer.features.includes(t.value))),l=t=>{const n=[];for(let s=0;s<t.length;s++)if((t[s].offer.type===o.value||o.value===e)&&i(t[s])&&(t[s].offer.rooms===+r.value||r.value===e)&&c(t[s])&&d(t[s])&&n.push(t[s]),5===n.length)return n;return n};t.addEventListener("change",(()=>{const e=l(window.data);window.pin.updatePins(e)})),window.filter=l})(),(()=>{const e=["gif","jpg","jpeg","png"];window.upload={setImagePreview:(t,o)=>{const n=t.files[0],r=n.type.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{"img"!==o.tagName.toLowerCase()?(o.style.backgroundSize="contain",o.style.backgroundImage=`url(${e.result})`):o.src=e.result})),e.readAsDataURL(n)}},removeImagePreview:e=>{"img"!==e.tagName.toLowerCase()?e.style.backgroundImage="":e.src="img/muffin-grey.svg"}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o=document.querySelector(".map__pins"),n=document.querySelector(".ad-form"),r=n.querySelector(".ad-form__reset"),s=e=>{window.util.checkPressEnter(e,l)},a=e=>{0===e.button&&l()},i=e=>{window.data=window.util.setIdToElements(e);const t=window.filter(window.data);window.form.enableFilters(),window.pin.placePins(t)},c=()=>{window.message.renderSuccessMessage(),n.reset(),u()},d=e=>{window.message.renderErrorMessage(e)},l=()=>{e.classList.remove("map--faded"),window.form.isPageActive=!0,window.form.enableForm(),window.backend.load(i,d),t.removeEventListener("mousedown",a),t.removeEventListener("keydown",s),o.addEventListener("click",window.pin.onMapPinsClick)},u=()=>{e.classList.contains("map--faded")||e.classList.add("map--faded"),window.form.isPageActive=!1,t.style.top="375px",t.style.left="570px",window.form.disableForm(),window.form.disableFilters(),window.card.closeCard(),window.pin.removePins(),t.addEventListener("mousedown",a),t.addEventListener("keydown",s),o.removeEventListener("click",window.pin.onMapPinsClick)};r.addEventListener("mousedown",(()=>{u()})),n.addEventListener("submit",(e=>{const t=new FormData(n);window.backend.upload(t,c,d),e.preventDefault()})),u()})()})();